// Blood Self-Hosted Compiler - HIR Crate and Lowering
//
// This module defines the top-level HIR structure (Crate) and types
// needed for AST-to-HIR lowering.
//
// Note: Due to blood-rust module system limitations with overlapping
// imports, this module uses a minimal import strategy. Types from
// hir_def and hir_ty are accessed through hir_item where needed.

mod common;
mod hir_def;
mod hir_ty;

// ============================================================
// Crate
// ============================================================

/// The HIR representation of a crate (compilation unit).
///
/// Contains all items and bodies with their DefIds/BodyIds as keys.
pub struct Crate {
    /// The entry point (main function) if present.
    pub entry: Option<hir_def.DefId>,
    /// The root module DefId.
    pub root_module: hir_def.DefId,
    /// Number of items.
    pub item_count: u32,
    /// Number of bodies.
    pub body_count: u32,
}

impl Crate {
    /// Creates an empty crate.
    pub fn new(root_module: hir_def.DefId) -> Crate {
        Crate {
            entry: None,
            root_module: root_module,
            item_count: 0,
            body_count: 0,
        }
    }
}

// ============================================================
// Diagnostics
// ============================================================

/// A diagnostic message (error, warning, note).
pub struct Diagnostic {
    /// The severity level.
    pub level: DiagnosticLevel,
    /// The error/warning code.
    pub code: DiagnosticCode,
    /// The main message.
    pub message: String,
    /// The primary span.
    pub span: common.Span,
}

impl Diagnostic {
    /// Creates a new error diagnostic.
    pub fn error(code: DiagnosticCode, message: String, span: common.Span) -> Diagnostic {
        Diagnostic {
            level: DiagnosticLevel.Error,
            code: code,
            message: message,
            span: span,
        }
    }

    /// Creates a new warning diagnostic.
    pub fn warning(code: DiagnosticCode, message: String, span: common.Span) -> Diagnostic {
        Diagnostic {
            level: DiagnosticLevel.Warning,
            code: code,
            message: message,
            span: span,
        }
    }
}

/// The severity level of a diagnostic.
pub enum DiagnosticLevel {
    /// An error that prevents compilation.
    Error,
    /// A warning that doesn't prevent compilation.
    Warning,
    /// A note providing additional information.
    Note,
    /// A help message.
    Help,
}

/// Diagnostic error codes.
pub enum DiagnosticCode {
    // Name resolution errors (E01xx)
    E0100,  // Name not found
    E0101,  // Duplicate definition
    E0102,  // Undefined name or unknown type
    E0103,  // Import not found
    E0104,  // Resolution error

    // Type errors (E02xx)
    E0200,  // Type mismatch
    E0201,  // Cannot infer type
    E0202,  // Invalid cast
    E0203,  // Missing trait implementation
    E0204,  // Type parameter bound not satisfied
    E0205,  // Invalid use of never type
    E0206,  // Recursive type without indirection

    // Expression errors (E03xx)
    E0300,  // Function validation error
    E0301,  // Cannot mutate immutable
    E0302,  // Invalid break/continue
    E0303,  // Missing return value
    E0304,  // Unreachable code
    E0305,  // Invalid method call

    // Pattern errors (E04xx)
    E0400,  // Non-exhaustive patterns
    E0401,  // Unreachable pattern
    E0402,  // Invalid pattern for type
    E0403,  // Binding in or-pattern

    // Effect errors (E05xx)
    E0500,  // Unhandled effect
    E0501,  // Effect not in scope
    E0502,  // Invalid resume
    E0503,  // Handler type mismatch

    // Borrow checker errors (E06xx)
    E0600,  // Use after move
    E0601,  // Cannot borrow as mutable
    E0602,  // Borrow conflict
    E0603,  // Lifetime mismatch
    E0604,  // Dangling reference

    // Internal errors (E09xx)
    E0900,  // Internal compiler error
}

// ============================================================
// Source Map
// ============================================================

/// Information about a source file.
pub struct SourceFile {
    /// The file path.
    pub path: String,
    /// The source content.
    pub source: String,
}

impl SourceFile {
    /// Creates a new source file.
    pub fn new(path: String, source: String) -> SourceFile {
        SourceFile {
            path: path,
            source: source,
        }
    }
}

// ============================================================
// HIR Visitor Trait Types
// ============================================================

/// Result of visiting an HIR node.
pub enum VisitResult {
    /// Continue visiting children.
    Continue,
    /// Skip children but continue siblings.
    SkipChildren,
    /// Stop visiting entirely.
    Stop,
}

/// Direction of traversal.
pub enum TraversalOrder {
    /// Visit parent before children.
    PreOrder,
    /// Visit children before parent.
    PostOrder,
}

//! # Emitter Configuration
//!
//! Configuration options for diagnostic emitters.
//!
//! ## Design Philosophy
//!
//! Configuration is separated into concerns:
//! - `EmitterConfig` - General emitter behavior
//! - `ColorConfig` - Color scheme customization
//!
//! This allows users to customize diagnostic output while
//! maintaining sensible defaults.

module std.compiler.diagnostics.emitter.config

use std.option.Option
use std.compiler.diagnostics.severity.Severity
use std.compiler.diagnostics.severity.AnsiColor

// ============================================================================
// Color Configuration
// ============================================================================

/// Color scheme for diagnostic output.
///
/// Allows customization of colors for different diagnostic components.
pub struct ColorConfig {
    /// Color for fatal errors.
    fatal_color: AnsiColor,

    /// Color for errors.
    error_color: AnsiColor,

    /// Color for warnings.
    warning_color: AnsiColor,

    /// Color for notes.
    note_color: AnsiColor,

    /// Color for help messages.
    help_color: AnsiColor,

    /// Color for remarks.
    remark_color: AnsiColor,

    /// Color for line numbers in the gutter.
    line_number_color: AnsiColor,

    /// Color for the vertical separator line.
    separator_color: AnsiColor,

    /// Color for primary labels/underlines.
    primary_label_color: AnsiColor,

    /// Color for secondary labels/underlines.
    secondary_label_color: AnsiColor,

    /// Color for source code text.
    source_color: AnsiColor,

    /// Color for suggestions.
    suggestion_color: AnsiColor,
}

impl ColorConfig {
    /// Create default color configuration.
    ///
    /// Uses standard terminal colors following rustc conventions:
    /// - Errors: Red
    /// - Warnings: Yellow
    /// - Notes: Cyan
    /// - Help: Green
    pub fn default() -> ColorConfig {
        ColorConfig {
            fatal_color: AnsiColor::BrightRed,
            error_color: AnsiColor::BrightRed,
            warning_color: AnsiColor::BrightYellow,
            note_color: AnsiColor::BrightCyan,
            help_color: AnsiColor::BrightGreen,
            remark_color: AnsiColor::BrightBlue,
            line_number_color: AnsiColor::BrightBlue,
            separator_color: AnsiColor::BrightBlue,
            primary_label_color: AnsiColor::BrightRed,
            secondary_label_color: AnsiColor::BrightCyan,
            source_color: AnsiColor::Reset,
            suggestion_color: AnsiColor::BrightGreen,
        }
    }

    /// Create high-contrast color scheme.
    ///
    /// Uses bold/bright colors for better visibility.
    pub fn high_contrast() -> ColorConfig {
        ColorConfig {
            fatal_color: AnsiColor::BrightRed,
            error_color: AnsiColor::BrightRed,
            warning_color: AnsiColor::BrightYellow,
            note_color: AnsiColor::BrightWhite,
            help_color: AnsiColor::BrightGreen,
            remark_color: AnsiColor::BrightMagenta,
            line_number_color: AnsiColor::BrightWhite,
            separator_color: AnsiColor::BrightWhite,
            primary_label_color: AnsiColor::BrightRed,
            secondary_label_color: AnsiColor::BrightYellow,
            source_color: AnsiColor::BrightWhite,
            suggestion_color: AnsiColor::BrightGreen,
        }
    }

    /// Create a no-color configuration.
    ///
    /// All colors are reset (no styling).
    pub fn none() -> ColorConfig {
        ColorConfig {
            fatal_color: AnsiColor::Reset,
            error_color: AnsiColor::Reset,
            warning_color: AnsiColor::Reset,
            note_color: AnsiColor::Reset,
            help_color: AnsiColor::Reset,
            remark_color: AnsiColor::Reset,
            line_number_color: AnsiColor::Reset,
            separator_color: AnsiColor::Reset,
            primary_label_color: AnsiColor::Reset,
            secondary_label_color: AnsiColor::Reset,
            source_color: AnsiColor::Reset,
            suggestion_color: AnsiColor::Reset,
        }
    }

    /// Get color for a severity level.
    pub fn color_for_severity(self, severity: Severity) -> AnsiColor {
        match severity {
            Severity::Fatal => self.fatal_color,
            Severity::Error => self.error_color,
            Severity::Warning => self.warning_color,
            Severity::Note => self.note_color,
            Severity::Help => self.help_color,
            Severity::Remark => self.remark_color,
        }
    }

    // === Builder Methods ===

    /// Set the error color.
    pub fn with_error_color(mut self, color: AnsiColor) -> ColorConfig {
        self.error_color = color
        self
    }

    /// Set the warning color.
    pub fn with_warning_color(mut self, color: AnsiColor) -> ColorConfig {
        self.warning_color = color
        self
    }

    /// Set the note color.
    pub fn with_note_color(mut self, color: AnsiColor) -> ColorConfig {
        self.note_color = color
        self
    }

    /// Set the help color.
    pub fn with_help_color(mut self, color: AnsiColor) -> ColorConfig {
        self.help_color = color
        self
    }

    /// Set the line number color.
    pub fn with_line_number_color(mut self, color: AnsiColor) -> ColorConfig {
        self.line_number_color = color
        self
    }

    /// Set the primary label color.
    pub fn with_primary_label_color(mut self, color: AnsiColor) -> ColorConfig {
        self.primary_label_color = color
        self
    }

    /// Set the secondary label color.
    pub fn with_secondary_label_color(mut self, color: AnsiColor) -> ColorConfig {
        self.secondary_label_color = color
        self
    }

    // === Accessors ===

    /// Get the fatal color.
    pub fn fatal_color(self) -> AnsiColor {
        self.fatal_color
    }

    /// Get the error color.
    pub fn error_color(self) -> AnsiColor {
        self.error_color
    }

    /// Get the warning color.
    pub fn warning_color(self) -> AnsiColor {
        self.warning_color
    }

    /// Get the note color.
    pub fn note_color(self) -> AnsiColor {
        self.note_color
    }

    /// Get the help color.
    pub fn help_color(self) -> AnsiColor {
        self.help_color
    }

    /// Get the remark color.
    pub fn remark_color(self) -> AnsiColor {
        self.remark_color
    }

    /// Get the line number color.
    pub fn line_number_color(self) -> AnsiColor {
        self.line_number_color
    }

    /// Get the separator color.
    pub fn separator_color(self) -> AnsiColor {
        self.separator_color
    }

    /// Get the primary label color.
    pub fn primary_label_color(self) -> AnsiColor {
        self.primary_label_color
    }

    /// Get the secondary label color.
    pub fn secondary_label_color(self) -> AnsiColor {
        self.secondary_label_color
    }

    /// Get the source color.
    pub fn source_color(self) -> AnsiColor {
        self.source_color
    }

    /// Get the suggestion color.
    pub fn suggestion_color(self) -> AnsiColor {
        self.suggestion_color
    }
}

// ============================================================================
// Emitter Configuration
// ============================================================================

/// Configuration for diagnostic emitters.
pub struct EmitterConfig {
    /// Color configuration.
    colors: ColorConfig,

    /// Whether to use colors in output.
    use_colors: Bool,

    /// Whether to use Unicode characters.
    use_unicode: Bool,

    /// Number of context lines before highlighted region.
    context_lines_before: U32,

    /// Number of context lines after highlighted region.
    context_lines_after: U32,

    /// Tab width for rendering source code.
    tab_width: U32,

    /// Whether to show line numbers.
    show_line_numbers: Bool,

    /// Whether to show error codes.
    show_error_codes: Bool,

    /// Whether to show suggestions.
    show_suggestions: Bool,

    /// Whether to show help messages.
    show_help: Bool,

    /// Whether to show related diagnostics.
    show_related: Bool,

    /// Maximum width of output (0 for unlimited).
    max_width: U32,

    /// Whether to wrap long lines.
    wrap_lines: Bool,

    /// Whether to show the full file path or just filename.
    show_full_path: Bool,
}

impl EmitterConfig {
    /// Create default configuration.
    ///
    /// Suitable for interactive terminal use.
    pub fn default() -> EmitterConfig {
        EmitterConfig {
            colors: ColorConfig::default(),
            use_colors: true,
            use_unicode: true,
            context_lines_before: 1,
            context_lines_after: 1,
            tab_width: 4,
            show_line_numbers: true,
            show_error_codes: true,
            show_suggestions: true,
            show_help: true,
            show_related: true,
            max_width: 0,
            wrap_lines: false,
            show_full_path: false,
        }
    }

    /// Create configuration for plain text output.
    ///
    /// No colors, ASCII-only characters.
    pub fn plain() -> EmitterConfig {
        EmitterConfig {
            colors: ColorConfig::none(),
            use_colors: false,
            use_unicode: false,
            context_lines_before: 1,
            context_lines_after: 1,
            tab_width: 4,
            show_line_numbers: true,
            show_error_codes: true,
            show_suggestions: true,
            show_help: true,
            show_related: true,
            max_width: 0,
            wrap_lines: false,
            show_full_path: false,
        }
    }

    /// Create minimal configuration.
    ///
    /// Only shows the essential information.
    pub fn minimal() -> EmitterConfig {
        EmitterConfig {
            colors: ColorConfig::default(),
            use_colors: true,
            use_unicode: true,
            context_lines_before: 0,
            context_lines_after: 0,
            tab_width: 4,
            show_line_numbers: true,
            show_error_codes: true,
            show_suggestions: false,
            show_help: false,
            show_related: false,
            max_width: 0,
            wrap_lines: false,
            show_full_path: false,
        }
    }

    /// Create verbose configuration.
    ///
    /// Shows maximum information with full context.
    pub fn verbose() -> EmitterConfig {
        EmitterConfig {
            colors: ColorConfig::default(),
            use_colors: true,
            use_unicode: true,
            context_lines_before: 3,
            context_lines_after: 3,
            tab_width: 4,
            show_line_numbers: true,
            show_error_codes: true,
            show_suggestions: true,
            show_help: true,
            show_related: true,
            max_width: 0,
            wrap_lines: false,
            show_full_path: true,
        }
    }

    /// Create configuration for JSON output.
    ///
    /// Used internally by JsonEmitter.
    pub fn json() -> EmitterConfig {
        EmitterConfig {
            colors: ColorConfig::none(),
            use_colors: false,
            use_unicode: true,
            context_lines_before: 2,
            context_lines_after: 2,
            tab_width: 4,
            show_line_numbers: true,
            show_error_codes: true,
            show_suggestions: true,
            show_help: true,
            show_related: true,
            max_width: 0,
            wrap_lines: false,
            show_full_path: true,
        }
    }

    // === Builder Methods ===

    /// Set the color configuration.
    pub fn with_colors(mut self, colors: ColorConfig) -> EmitterConfig {
        self.colors = colors
        self
    }

    /// Enable/disable color output.
    pub fn with_color_enabled(mut self, enabled: Bool) -> EmitterConfig {
        self.use_colors = enabled
        self
    }

    /// Enable/disable Unicode characters.
    pub fn with_unicode(mut self, enabled: Bool) -> EmitterConfig {
        self.use_unicode = enabled
        self
    }

    /// Set context lines.
    pub fn with_context(mut self, before: U32, after: U32) -> EmitterConfig {
        self.context_lines_before = before
        self.context_lines_after = after
        self
    }

    /// Set tab width.
    pub fn with_tab_width(mut self, width: U32) -> EmitterConfig {
        self.tab_width = width
        self
    }

    /// Enable/disable line numbers.
    pub fn with_line_numbers(mut self, show: Bool) -> EmitterConfig {
        self.show_line_numbers = show
        self
    }

    /// Enable/disable error codes.
    pub fn with_error_codes(mut self, show: Bool) -> EmitterConfig {
        self.show_error_codes = show
        self
    }

    /// Enable/disable suggestions.
    pub fn with_suggestions(mut self, show: Bool) -> EmitterConfig {
        self.show_suggestions = show
        self
    }

    /// Enable/disable help messages.
    pub fn with_help(mut self, show: Bool) -> EmitterConfig {
        self.show_help = show
        self
    }

    /// Enable/disable related diagnostics.
    pub fn with_related(mut self, show: Bool) -> EmitterConfig {
        self.show_related = show
        self
    }

    /// Set maximum output width.
    pub fn with_max_width(mut self, width: U32) -> EmitterConfig {
        self.max_width = width
        self
    }

    /// Enable/disable line wrapping.
    pub fn with_line_wrapping(mut self, wrap: Bool) -> EmitterConfig {
        self.wrap_lines = wrap
        self
    }

    /// Enable/disable full path display.
    pub fn with_full_path(mut self, show: Bool) -> EmitterConfig {
        self.show_full_path = show
        self
    }

    // === Accessors ===

    /// Get the color configuration.
    pub fn colors(self) -> ColorConfig {
        self.colors.clone()
    }

    /// Check if colors are enabled.
    pub fn use_colors(self) -> Bool {
        self.use_colors
    }

    /// Check if Unicode is enabled.
    pub fn use_unicode(self) -> Bool {
        self.use_unicode
    }

    /// Get context lines before.
    pub fn context_lines_before(self) -> U32 {
        self.context_lines_before
    }

    /// Get context lines after.
    pub fn context_lines_after(self) -> U32 {
        self.context_lines_after
    }

    /// Get tab width.
    pub fn tab_width(self) -> U32 {
        self.tab_width
    }

    /// Check if line numbers are shown.
    pub fn show_line_numbers(self) -> Bool {
        self.show_line_numbers
    }

    /// Check if error codes are shown.
    pub fn show_error_codes(self) -> Bool {
        self.show_error_codes
    }

    /// Check if suggestions are shown.
    pub fn show_suggestions(self) -> Bool {
        self.show_suggestions
    }

    /// Check if help is shown.
    pub fn show_help(self) -> Bool {
        self.show_help
    }

    /// Check if related diagnostics are shown.
    pub fn show_related(self) -> Bool {
        self.show_related
    }

    /// Get maximum width.
    pub fn max_width(self) -> U32 {
        self.max_width
    }

    /// Check if line wrapping is enabled.
    pub fn wrap_lines(self) -> Bool {
        self.wrap_lines
    }

    /// Check if full paths are shown.
    pub fn show_full_path(self) -> Bool {
        self.show_full_path
    }

    // === Character Accessors ===

    /// Get the vertical line character.
    pub fn vertical_line(self) -> String {
        if self.use_unicode { "│" } else { "|" }
    }

    /// Get the horizontal line character.
    pub fn horizontal_line(self) -> String {
        if self.use_unicode { "─" } else { "-" }
    }

    /// Get the corner character (top-left).
    pub fn corner_tl(self) -> String {
        if self.use_unicode { "╭" } else { "+" }
    }

    /// Get the corner character (bottom-left).
    pub fn corner_bl(self) -> String {
        if self.use_unicode { "╰" } else { "+" }
    }

    /// Get the arrow character.
    pub fn arrow(self) -> String {
        if self.use_unicode { "→" } else { "->" }
    }

    /// Get the primary underline character.
    pub fn primary_underline(self) -> String {
        "^"
    }

    /// Get the secondary underline character.
    pub fn secondary_underline(self) -> String {
        "-"
    }
}

// ============================================================================
// Tests
// ============================================================================

#[test]
fn test_color_config_default() {
    let colors = ColorConfig::default()

    assert(colors.error_color() == AnsiColor::BrightRed)
    assert(colors.warning_color() == AnsiColor::BrightYellow)
    assert(colors.note_color() == AnsiColor::BrightCyan)
    assert(colors.help_color() == AnsiColor::BrightGreen)
}

#[test]
fn test_color_config_none() {
    let colors = ColorConfig::none()

    assert(colors.error_color() == AnsiColor::Reset)
    assert(colors.warning_color() == AnsiColor::Reset)
    assert(colors.note_color() == AnsiColor::Reset)
}

#[test]
fn test_color_for_severity() {
    let colors = ColorConfig::default()

    assert(colors.color_for_severity(Severity::Error) == AnsiColor::BrightRed)
    assert(colors.color_for_severity(Severity::Warning) == AnsiColor::BrightYellow)
    assert(colors.color_for_severity(Severity::Note) == AnsiColor::BrightCyan)
    assert(colors.color_for_severity(Severity::Help) == AnsiColor::BrightGreen)
}

#[test]
fn test_emitter_config_default() {
    let config = EmitterConfig::default()

    assert(config.use_colors())
    assert(config.use_unicode())
    assert(config.show_line_numbers())
    assert(config.show_error_codes())
    assert(config.show_suggestions())
    assert(config.context_lines_before() == 1)
    assert(config.context_lines_after() == 1)
}

#[test]
fn test_emitter_config_plain() {
    let config = EmitterConfig::plain()

    assert(!config.use_colors())
    assert(!config.use_unicode())
    assert(config.show_line_numbers())
}

#[test]
fn test_emitter_config_minimal() {
    let config = EmitterConfig::minimal()

    assert(config.use_colors())
    assert(!config.show_suggestions())
    assert(!config.show_help())
    assert(!config.show_related())
    assert(config.context_lines_before() == 0)
}

#[test]
fn test_emitter_config_verbose() {
    let config = EmitterConfig::verbose()

    assert(config.show_full_path())
    assert(config.context_lines_before() == 3)
    assert(config.context_lines_after() == 3)
}

#[test]
fn test_emitter_config_characters() {
    let config = EmitterConfig::default()
    assert(config.vertical_line() == "│")
    assert(config.arrow() == "→")

    let plain = EmitterConfig::plain()
    assert(plain.vertical_line() == "|")
    assert(plain.arrow() == "->")
}

#[test]
fn test_emitter_config_builder() {
    let config = EmitterConfig::default()
        .with_unicode(false)
        .with_context(2, 3)
        .with_tab_width(8)

    assert(!config.use_unicode())
    assert(config.context_lines_before() == 2)
    assert(config.context_lines_after() == 3)
    assert(config.tab_width() == 8)
}

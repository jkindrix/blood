name: Fuzz

on:
  # Run on schedule for continuous fuzzing
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  # Allow manual triggers
  workflow_dispatch:
    inputs:
      duration:
        description: 'Fuzzing duration in seconds'
        required: false
        default: '600'
      target:
        description: 'Fuzz target to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - fuzz_lexer
          - fuzz_parser
          - fuzz_parser_expr
          - fuzz_grammar
          - fuzz_effects
          - fuzz_handler

env:
  CARGO_TERM_COLOR: always
  LLVM_VERSION: "18"

jobs:
  fuzz:
    name: Fuzz (${{ matrix.target }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target: [fuzz_lexer, fuzz_parser, fuzz_parser_expr, fuzz_grammar, fuzz_effects, fuzz_handler]

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: llvm-tools-preview

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "bloodc/fuzz -> target"

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz

      - name: Install LLVM
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh ${{ env.LLVM_VERSION }}
          echo "LLVM_SYS_181_PREFIX=/usr/lib/llvm-${{ env.LLVM_VERSION }}" >> $GITHUB_ENV

      - name: Run fuzzer
        working-directory: bloodc
        run: |
          DURATION="${{ github.event.inputs.duration || '600' }}"
          echo "Running ${{ matrix.target }} for ${DURATION} seconds"
          cargo +nightly fuzz run ${{ matrix.target }} -- \
            -max_total_time=${DURATION} \
            -jobs=2 \
            -workers=2 \
            -print_final_stats=1 \
        continue-on-error: true

      - name: Upload crash artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: crash-${{ matrix.target }}-${{ github.run_id }}
          path: |
            bloodc/fuzz/artifacts/${{ matrix.target }}/**
          retention-days: 30

      - name: Upload corpus
        uses: actions/upload-artifact@v4
        with:
          name: corpus-${{ matrix.target }}-${{ github.run_id }}
          path: |
            bloodc/fuzz/corpus/${{ matrix.target }}/**
          retention-days: 7

  # Quick smoke test on PRs
  fuzz-smoke:
    name: Fuzz Smoke Test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: llvm-tools-preview

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "bloodc/fuzz -> target"

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz

      - name: Install LLVM
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh ${{ env.LLVM_VERSION }}
          echo "LLVM_SYS_181_PREFIX=/usr/lib/llvm-${{ env.LLVM_VERSION }}" >> $GITHUB_ENV

      - name: Quick fuzz test (parser)
        working-directory: bloodc
        run: |
          cargo +nightly fuzz run fuzz_parser -- -max_total_time=30
        continue-on-error: true

      - name: Quick fuzz test (grammar)
        working-directory: bloodc
        run: |
          cargo +nightly fuzz run fuzz_grammar -- -max_total_time=30
        continue-on-error: true

  # Report crashes
  report-crashes:
    name: Report Crashes
    runs-on: ubuntu-latest
    needs: fuzz
    if: always()

    steps:
      - uses: actions/checkout@v4

      - name: Download crash artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: crash-*
          path: crashes
          merge-multiple: true
        continue-on-error: true

      - name: Check for crashes
        id: check-crashes
        run: |
          if [ -d "crashes" ] && [ "$(ls -A crashes 2>/dev/null)" ]; then
            echo "has_crashes=true" >> $GITHUB_OUTPUT
            echo "Found crashes:"
            find crashes -type f | head -20
          else
            echo "has_crashes=false" >> $GITHUB_OUTPUT
            echo "No crashes found"
          fi

      - name: Create issue for crashes
        if: steps.check-crashes.outputs.has_crashes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Find crash files
            const crashDir = 'crashes';
            let crashList = '';
            const walkSync = (dir) => {
              const files = fs.readdirSync(dir);
              files.forEach(file => {
                const filePath = path.join(dir, file);
                if (fs.statSync(filePath).isDirectory()) {
                  walkSync(filePath);
                } else {
                  crashList += `- ${filePath}\n`;
                }
              });
            };

            if (fs.existsSync(crashDir)) {
              walkSync(crashDir);
            }

            const issueBody = `## Fuzzing Crashes Detected

            The daily fuzzing run detected potential crashes.

            ### Crash Files
            ${crashList || 'No crash files found'}

            ### Run Details
            - Run ID: ${{ github.run_id }}
            - Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ### Next Steps
            1. Download crash artifacts from the workflow run
            2. Reproduce locally with \`cargo fuzz run <target> <crash_file>\`
            3. Fix the issue and add a regression test
            `;

            // Check for existing open issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'fuzzing,bug'
            });

            const existingIssue = issues.find(i => i.title.includes('Fuzzing Crashes'));

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `New crashes detected in run ${{ github.run_id }}\n\n${crashList}`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Fuzzing Crashes Detected',
                body: issueBody,
                labels: ['fuzzing', 'bug']
              });
            }
